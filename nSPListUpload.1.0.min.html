<!-- nSPListUpload | https://github.com/imthenachoman/nSPListUpload | Copyright (c) 2015 Anchal Nigam (imthenachoman@gmail.com) | MIT license (http://opensource.org/licenses/mit) -->
<style type="text/css">.nInputWrapper .nOutput{display:none;padding:5px}.nInputWrapper .nInput input{margin:5px 0;display:inline-block}.nInputWrapper .nInput .big{width:391px}img.nachoImage{border:0;width:300px}</style>
<script type="text/javascript">(function(){var x=location.protocol+"//"+location.hostname+(_spPageContextInfo.webServerRelativeUrl==="/"?"":_spPageContextInfo.webServerRelativeUrl)+"/";if(!String.prototype.trim)String.prototype.trim=function(){return this.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")};var y=function(a,b,c,d){var e=document.createElement(a);if(c)e.className=c;if(d){for(attribute in d){if(attribute.startsWith("inner")||attribute.startsWith("on"))e[attribute]=d[attribute];else e.setAttribute(attribute,d[attribute])}}if(b)b.appendChild(e);return e};var z=function(a,b,c,d){var e=typeof XMLHttpRequest!='undefined'?new XMLHttpRequest():new ActiveXObject('Microsoft.XMLHTTP');e.open("post",x+"_vti_bin/"+a,true);e.setRequestHeader("SOAPAction",b);e.setRequestHeader("Content-Type","text/xml; charset=\"utf-8\"");e.responseType="xml";e.onreadystatechange=function(){if(e.readyState==4){if(e.status==200){d("success",e)}else{d("error","there was an error")}}};e.send('<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"><soap:Body>'+c+'</soap:Body></soap:Envelope>')};var A=function(p){if(GetUrlKeyValue("nachoUpdateItem")==="1"){document.getElementById("MSO_ContentTable").innerHTML="<div style='display: block; text-align: center; padding: 10px 5px 0 5px;'>Please wait while I finish making updates...</div>";setTimeout(function(){z("Lists.asmx?op=GetListItems","http://schemas.microsoft.com/sharepoint/soap/GetListItems",'<GetListItems xmlns="http://schemas.microsoft.com/sharepoint/soap/"><listName>'+_spPageContextInfo.pageListId+'</listName><query><Query><Where><Eq><FieldRef Name="Author" LookupId="TRUE"/><Value Type="Integer">1</Value></Eq></Where><OrderBy><FieldRef Name="Modified" Ascending="False" /></OrderBy></Query></query><viewFields><ViewFields><FieldRef Name="ID" /></ViewFields></viewFields><rowLimit>1</rowLimit></GetListItems>',function(c,d){if(c==="success"){var e=d.responseXML.getElementsByTagName("z:row")[0].getAttribute("ows_ID");eval("var attachList = "+GetUrlKeyValue("nachoAttachList").replace(/\/Attachments\/\//g,"/Attachments/"+e+"/"));var f='<Field Name="ID">'+e+'</Field>';for(var g in attachList){f+='<Field Name="'+g+'">'+attachList[g]+'</Field>'}z("Lists.asmx?op=UpdateListItems","http://schemas.microsoft.com/sharepoint/soap/UpdateListItems",'<UpdateListItems xmlns="http://schemas.microsoft.com/sharepoint/soap/"><listName>'+_spPageContextInfo.pageListId+'</listName><updates><Batch OnError="Continue"><Method ID="1" Cmd="Update">'+f+'</Method></Batch></updates></UpdateListItems>',function(a,b){if(a==="success"){if(GetUrlKeyValue("IsDlg")==="1")window.frameElement.commitPopup();else window.location=location.href.split("?")[0].split("/").slice(0,-1).join("/")}else{alert("There was an error updating the item you created.")}})}else{alert("There was an error getting the ID of the last item you created.")}})},1)}else{var q=false;var r=document.querySelectorAll("textarea[name][title]");for(var i=0,num=r.length;i<num;++i){var s=r[i];if(!/\bfile\b/i.test(s.title))continue;q=true;var t=/\burl\b/i.test(s.title);if(!t){s.style.display="none"}var u=/\bimage\b/i.test(s.title);s.onchange=B;s.parentNode.className+="nInput";s.parentNode.insertBefore(y("input",null,"big",{"type":"file","title":"Upload File","name":"upload"+i,"onchange":B}),s.nextSibling);if(t)s.parentNode.insertBefore(y("br"),s.nextSibling);var v=y("div",null,"nInputWrapper");s.parentNode.parentNode.insertBefore(v,s.parentNode);v.appendChild(s.parentNode);var w=y("div",v,"nOutput");var a=y("a",w,"link",{"href":s.value,"target":"_blank","innerText":s.value});if(u){y("br",a);y("img",a,"nachoImage",{"src":s.value})}y("span",w,null,{"innerHTML":"&nbsp;"});if(/\/Attachments\/\d+\//.test(s.value))y("a",w,null,{"href":"#","onclick":D,"innerText":"(delete)"});else y("a",w,null,{"href":"#","onclick":C,"innerText":"(remove)"});if(p){s.parentNode.style.display="none";w.style.display="block"}}if(q){window["PreSaveAction"]=function(){var a=[];var b=GetUrlKeyValue("ID");var c=location.href.split("?")[0].split("/").slice(0,-1).join("/");var d=document.querySelectorAll("div.nInputWrapper");for(var i=0,num=d.length;i<num;++i){var e=d[i];var f=e.querySelector("textarea");var g=f.title.replace(/ Required Field$/,"");var h=e.parentNode.innerHTML.match(/FieldInternalName="(.*?)"/)[1];var j=e.querySelector("input");if(j.value){var k=E(j.value);f.value=c+"/Attachments/"+b+"/"+escape(k);a.push('"'+h+'":"'+escape(f.value)+'"')}}if(a.length){a="{"+a.join(",")+"}";document.forms[0].encoding="multipart/form-data";var l=document.querySelectorAll("input[name^='fileupload']");var m=l.length;l[m-1].parentNode.removeChild(l[m-1]);var n=document.querySelectorAll("div.nInputWrapper input[type='file']");for(var i=0,num=n.length;i<num;++i){n[i].name="fileupload"+m++}if(b===""){var o=escape(location.pathname+"?nachoUpdateItem=1"+(GetUrlKeyValue("IsDlg")==="1"?"&IsDlg=1":"")+"&nachoAttachList="+a);document.getElementById("aspnetForm").action=location.pathname+"?Source="+o}}return true}}}};var B=function(){var a=this.value.trim();if(!a)return;var b=this.parentNode;var c=b.nextSibling;var d=b.querySelector("textarea");var e=b.querySelector("input");var f=c.querySelector("a.link");var g=f.querySelector("img");if(this==d){var h=e.cloneNode();h["onchange"]=B;e.parentNode.replaceChild(h,e)}else{d.value=""}if(g){f.href=a;g.src=a}else{f.innerText=a;f.href=a}b.style.display="none";c.style.display="block";return false};var C=function(){var a=this.parentNode;var b=a.previousSibling;var c=b.querySelector("textarea");var d=b.querySelector("input");var e=a.querySelector("a.link");var f=e.querySelector("img");c.value="";var g=d.cloneNode();g["onchange"]=B;d.parentNode.replaceChild(g,d);if(f){e.href="";f.src=""}else{e.innerText="";e.href=""}b.style.display="block";a.style.display="none";return false};var D=function(){var a=E(this.parentNode.previousSibling.querySelector("textarea").value);RemoveAttachmentFromServer(document.querySelector("#idAttachmentsTable a[href$='"+a+"']").parentNode.parentNode.parentNode.id,1);this.innerText="(remove)";this.onclick=C;this.onclick();return false};var E=function(a){return a.split(/\\|\//).pop()};switch(E(location.pathname).toLowerCase()){case"newform.aspx":A(false);break;case"editform.aspx":A(true);break;case"dispform.aspx":var F=document.querySelectorAll("h3.ms-standardheader");for(var i=0,num=F.length;i<num;++i){var G=F[i];if(/(?=.*image)(?=.*file)/i.test(G.innerText)){var a=G.parentNode.parentNode.querySelectorAll("a");if(a.length>1){a=a[1];a.innerHTML+="<br /><br /><img class='nachoImage' src='"+a.href+"' />"}}}break;default:alert("I do not know what to do with this page.")}})();</script>
